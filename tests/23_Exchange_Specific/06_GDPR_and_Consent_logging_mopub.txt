*** Settings ***
Resource             exchange_specific_imports.txt
Force Tags           GDPR 	CONSENT    BATCH3		MOPUB 	
Suite Teardown      Close All Connections

*** variables ***
 ${app_id}					13488
 ${agid_expected}			34990
 
*** Test Cases ***
# Mopub does not have app ID or site ID. it will use the name lowercase, md5

Mopub - Logging GDPR (blank) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en"}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				38=\r
	   
Mopub - Logging GDPR (0) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en"},"regs":{"ext":{"gdpr":0}}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				38=0
	    
Mopub - Logging GDPR (1) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en"},"regs":{"ext":{"gdpr":1}}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				38=1

Mopub - GDPR (blank) ads serve
	   Set Test Variable	${auction_price}	0.0317   
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"x714109929","cat":["IAB24","social_networking"],"id":"${app_id}","name":"LikeBook (Free) - for Facebook with Myanmar Keyboard","publisher":{"id":"1d31b4cbe76c4667a7b158b8080a5432","name":"myOpenware"},"storeurl":"https://itunes.apple.com/us/app/likebook-free-for-facebook/id714109929?mt=8&uo=4","ver":"2.4"},"at":2,"bcat":["IAB25","IAB26","IAB7-39","IAB8-18","IAB8-5","IAB9-9","IAB3-7"],"device":{"carrier":"310-260","connectiontype":3,"devicetype":1,"dnt":0,"dpidmd5":"4540383a49aea4ced584a6a2a07f646c","dpidsha1":"8cc6619ea58728484da209f625be222e635cdd32","ifa":"${device_id}","geo":{"city":"Brooklyn","country":"USA","lat":38.842331,"lon":-77.091995,"metro":"501","region":"NY","zip":"11237"},"ip":"172.56.35.127","js":1,"language":"en","make":"Apple","model":"iPhone 5s (GSM)","os":"iOS","osv":"8.1.1","ua":"Mozilla/5.0 (iPhone; CPU iPhone OS 8_1_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12B435 [FBAN/FBIOS;FBAV/5.5;FBBV/114387;FBDV/iPhone6,1;FBMD/iPhone;FBSN/iPhone OS;FBSV/8.1.1;FBSS/2;FBCR/T-Mobile;FBID/phone;FBLC/en_US]"},"id":"6f382f0d-95c3-4499-939c-48363f03f982","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"nativebrowserclick":1},"h":50,"pos":1,"w":320},"bidfloor":0.0220,"displaymanager":"mopub","displaymanagerver":"3.3.0","ext":{"secure":0},"id":"1","instl":0,"tagid":"901a0c26d9b34e3abb1e29b55ac8ef21"}]} 
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=200	adgroup_expected=${agid_expected}        submit_client_impression_event=NO		
	   
Mopub - GDPR (0) ads serve
	   Set Test Variable	${auction_price}	0.0317   
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"x714109929","cat":["IAB24","social_networking"],"id":"${app_id}","name":"LikeBook (Free) - for Facebook with Myanmar Keyboard","publisher":{"id":"1d31b4cbe76c4667a7b158b8080a5432","name":"myOpenware"},"storeurl":"https://itunes.apple.com/us/app/likebook-free-for-facebook/id714109929?mt=8&uo=4","ver":"2.4"},"at":2,"bcat":["IAB25","IAB26","IAB7-39","IAB8-18","IAB8-5","IAB9-9","IAB3-7"],"device":{"carrier":"310-260","connectiontype":3,"devicetype":1,"dnt":0,"dpidmd5":"4540383a49aea4ced584a6a2a07f646c","dpidsha1":"8cc6619ea58728484da209f625be222e635cdd32","ifa":"${device_id}","geo":{"city":"Brooklyn","country":"USA","lat":38.842331,"lon":-77.091995,"metro":"501","region":"NY","zip":"11237"},"ip":"172.56.35.127","js":1,"language":"en","make":"Apple","model":"iPhone 5s (GSM)","os":"iOS","osv":"8.1.1","ua":"Mozilla/5.0 (iPhone; CPU iPhone OS 8_1_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12B435 [FBAN/FBIOS;FBAV/5.5;FBBV/114387;FBDV/iPhone6,1;FBMD/iPhone;FBSN/iPhone OS;FBSV/8.1.1;FBSS/2;FBCR/T-Mobile;FBID/phone;FBLC/en_US]"},"id":"6f382f0d-95c3-4499-939c-48363f03f982","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"nativebrowserclick":1},"h":50,"pos":1,"w":320},"bidfloor":0.0220,"displaymanager":"mopub","displaymanagerver":"3.3.0","ext":{"secure":0},"id":"1","instl":0,"tagid":"901a0c26d9b34e3abb1e29b55ac8ef21"}],"regs":{"ext":{"gdpr":0}}} 
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=200	adgroup_expected=${agid_expected}        submit_client_impression_event=NO		
	   
Mopub - GDPR (1) ads not serve
		Set Test Variable	${auction_price}	0.0317   
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"x714109929","cat":["IAB24","social_networking"],"id":"${app_id}","name":"LikeBook (Free) - for Facebook with Myanmar Keyboard","publisher":{"id":"1d31b4cbe76c4667a7b158b8080a5432","name":"myOpenware"},"storeurl":"https://itunes.apple.com/us/app/likebook-free-for-facebook/id714109929?mt=8&uo=4","ver":"2.4"},"at":2,"bcat":["IAB25","IAB26","IAB7-39","IAB8-18","IAB8-5","IAB9-9","IAB3-7"],"device":{"carrier":"310-260","connectiontype":3,"devicetype":1,"dnt":0,"dpidmd5":"4540383a49aea4ced584a6a2a07f646c","dpidsha1":"8cc6619ea58728484da209f625be222e635cdd32","ifa":"${device_id}","geo":{"city":"Brooklyn","country":"USA","lat":38.842331,"lon":-77.091995,"metro":"501","region":"NY","zip":"11237"},"ip":"172.56.35.127","js":1,"language":"en","make":"Apple","model":"iPhone 5s (GSM)","os":"iOS","osv":"8.1.1","ua":"Mozilla/5.0 (iPhone; CPU iPhone OS 8_1_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Mobile/12B435 [FBAN/FBIOS;FBAV/5.5;FBBV/114387;FBDV/iPhone6,1;FBMD/iPhone;FBSN/iPhone OS;FBSV/8.1.1;FBSS/2;FBCR/T-Mobile;FBID/phone;FBLC/en_US]"},"id":"6f382f0d-95c3-4499-939c-48363f03f982","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"nativebrowserclick":1},"h":50,"pos":1,"w":320},"bidfloor":0.0220,"displaymanager":"mopub","displaymanagerver":"3.3.0","ext":{"secure":0},"id":"1","instl":0,"tagid":"901a0c26d9b34e3abb1e29b55ac8ef21"}],"regs":{"ext":{"gdpr":1}}} 
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204	
	   
Mopub - Logging Consent (0) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en","ext":{"consent":0}}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				39=0

Mopub - Logging Consent (blank) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en"}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				39=\r

Mopub - Logging Consent (1) in request log
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable    ${data}   		  {"app":{"bundle":"com.sgiggle.production","storeurl":"https://itunes.apple.com/us/app/chatous/id698054232?mt=8&uo=4","cat":["IAB24","social_networking"],"id":"123456","name":"TangoAndroid-PRODUCTION","publisher":{"id":"8f2cdeb4f21b486f970dedc3bb1dcaac","name":"Tango"}},"at":2,"badv":["www.xtreme-slots.com"],"bcat":["IAB26","IAB3-7"],"device":{"connectiontype":2,"devicetype":1,"dnt":0,"dpidmd5":"7e150cebc7742127d3cc156a10766a6f","dpidsha1":"8c031cdfef2913d489ff6a83c0cb025b9a799ba1","ifa":"${device_id}","geo":{"city":"EwaBeach","country":"USA","lat":21.3256,"lon":-158.056,"metro":"744","region":"HI","zip":"96706"},"ip":"67.49.148.178","js":1,"language":"en","os":"Android","osv":"5.1.1","ua":"Mozilla/5.0(Linux;Android5.1.1;SM-N910PBuild/LMY47X;wv)AppleWebKit/537.36(KHTML,likeGecko)Version/4.0Chrome/44.0.2403.90MobileSafari/537.36"},"id":"cff2ce5d-e0ad-43bb-bc68-75d04971c49c","imp":[{"banner":{"api":[3,5],"battr":[3,8,9,10,14,6],"btype":[4],"ext":{"native":{"type":"install","ver":"1.1"},"nativead":{"type":"install","ver":"1.1"}},"h":0,"pos":1,"w":0},"bidfloor":2.77,"displaymanager":"mopub","displaymanagerver":"3.3","id":"1","instl":0,"tagid":"edf8540c38704aeb8cd06103b9a8ea8e"}],"user":{"gender":"male","keywords":"m_pstnOnboardStatus:3,m_dlpaywal:1,m_dlver:e,m_usertype:1,m_androidpremium:1,m_mcc_mnc:310120,m_dev:sm-n910p_trltespr,m_locale:en","ext":{"consent":1}}}	   
	   RTB Request 				API=${RTB_MOPUB_API}          data=${data}		response_code=204        submit_client_impression_event=NO
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   Should Match Regexp 			${output}  				39=1
	    