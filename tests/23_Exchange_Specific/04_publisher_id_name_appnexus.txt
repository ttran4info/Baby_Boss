*** Settings ***
Resource             exchange_specific_imports.txt
Force Tags           PUBLISHER    BATCH3	APPNEXUS 	
Suite Teardown      Close All Connections

*** variables ***
 ${app_id}					13189
 ${site_id}					13192
 
*** Test Cases ***
# Appnexus does not have publisher name

Appnexus - Logging publisher id available, publisher name is not available
	[Documentation]		When publisher name is not available, and publisher id is available, publisher name = exchange: publisher id 
	   ${device_id}=		Generate Clear Device ID
	   Set Test Variable	${publisher_id}			234567
	   #Set Test Variable    ${data}   		  {"bid_request":{"timestamp":"2015-06-0400:48:07","bidder_timeout_ms":100,"members":[{"id":2049}],"member_ad_profile_id":198147,"excluded_categories":[13,17,29,38,39,60,78,80,116,118],"excluded_technical_attributes":[33],"tags":[{"auction_id_64":36802637825020984,"size":"300x250","sizes":["300x250"],"smaller_sizes_allowed":false,"position":"unknown","tag_format":"iframe","supply_type":"mobile_app","site_id":886154,"ad_profile_id":251049,"visibility_profile_id":990,"venue_id":744119,"inventory_source_id":1719,"allowed_media_types":[1],"media_subtypes":["banner"],"estimated_clear_price":0.248,"estimated_average_price":0.081,"id":3620009,"inventory_audits":[{"auditor_member_id":2066,"content_categories":[10,13]}]}],"bid_info":{"user_id_64":6254650908374539000,"no_cookies":false,"payment_rule_id":507442,"no_flash":false,"certified_supply":true,"user_agent":"Mozilla/5.0(iPad;CPUOS8_1_1likeMacOSX)AppleWebKit/600.1.4(KHTML,likeGecko)Mobile/12B435","browser":0,"operating_system":10,"operating_system_extended":129,"operating_system_family":3,"carrier":1,"device_make":26,"device_model":300,"device_type":3,"session_freq":1,"pub_session_freq":1,"ip_address":"76.30.108.22","country":"US","region":"TX","city":"SugarLand","postal_code":"77479","dma":618,"time_zone":"America/Chicago","inventory_class":"class_3","within_iframe":false,"device_ids":{"idfa":"${device_id}","sha1udid":"a9dea295df1cdb430706204134814a4c16bd9d99","md5udid":"52a2ffd2f1210a377d4365bbb816f386"},"selling_member_id":2066,"publisher_id":234567,"app_id":"123456","app_name":"AppName","mobile_app_instance_id":685,"inventory_audits":[{"auditor_member_id":null,"inventory_attributes":[]}],"userdata_json":"{}","segments":[{"id":1,"member_id":0,"code":"cookie_birthday","provider":"Appnexus","last_seen_min":23118867}]}}}	   
	   Set Test Variable    ${data}   		  {"id": "8765482113786061111","imp": [{"id": "449387476987463500","banner": {"w": 320,"h": 50,"id": "1","battr": [1, 2, 15],"pos": 0,"format": [{"w": 320,"h": 50}]},"instl": 0,"tagid": "12347654","secure": 1,"ext": {"appnexus": {"estimated_clear_price": 0.57,"predicted_view_rate": 0.073255,"member_ad_profile_id": 1111055,"predicted_video_completion_rate": 0.592172,"predicted_view_rate_over_total": 0.067229,"allowed_payment_types": [{"payment_type": 1,"imp_count_method": 2}]}}}],"app": {"id": "${app_id}","domain": "example.com","cat": ["IAB12-2", "IAB12", "IAB11-5"],"page": "https://example.com/somepage.html","publisher": {"id": "${publisher_id}"}},"device": {"ua": "Mozilla/5.0 (Linux; Android 6.0.1; HUAWEI Build/MMB28B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.137 Mobile Safari/537.36","geo": {"lat": 36.6203,"lon": -4.4998,"country": "US","region": "MA","metro": "1","city": "UnaCuidad","zip": "94110","utcoffset": 60,"ext": {"appnexus": {"timezone": "Africa/Ceuta"}}},"dnt": 0,"ip": "11.222.111.0","devicetype": 3,"ifa": "${device_id}","make": "Unknown","model": "Generic Android Mobile","os": "Android","language": "es","connectiontype": 0},"user": {"id": "7939999668795769876","buyeruid": "CABBBBrbuQ9AA5DMJJJJlOL9ZOo","gender": "O","data": [{"id": "0","segment": [{"id": "1","value": "0"}]}, {"id": "1234","segment": [{"id": "4444555","value": "0"}]}]},"test": 0,"at": 1,"tmax": 150,"wseat": ["1234"],"cur": ["USD"],"bcat": ["IAB23-7", "IAB23-5", "IAB23-10", "IAB23-9", "IAB23-1", "IAB7-44", "IAB9-9", "IAB8-18", "IAB8-5"],"badv": ["url1.com", "url2.com"],"ext": {"appnexus": {"seller_member_id": 123,"spend_protection": true,"publisher_integration": {"is_header": 0,"bid_shading_high": 1,"bid_shading_medium": 0.35,"bid_shading_low": 0.95}}},"source": {"fd": 1,"tid": "2dd111ff-7777-4abc-8558-86a123ab46d6"}}	
     
	   RTB Appnexus Request             ${RTB_APPNEXUS_API}        ${data} 
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}
	   #field 73 - pub id, field 74 - pub name
	   Should Match Regexp 			${output}  				73=${publisher_id}
	   Should Match Regexp 			${output}  				74=AppNexus: ${publisher_id}

  		

Appnexus - Logging publisher id and name are not available id = md5(exchange: not available), name = exchange: not available
	[Documentation]		When publisher name and id is not available log, log exchange name not available	
	   ${device_id}=		Generate Clear Device ID
	   #Set Test Variable    ${data}   		  {"bid_request":{"timestamp":"2015-06-0400:48:07","bidder_timeout_ms":100,"members":[{"id":2049}],"member_ad_profile_id":198147,"excluded_categories":[13,17,29,38,39,60,78,80,116,118],"excluded_technical_attributes":[33],"tags":[{"auction_id_64":36802637825020984,"size":"300x250","sizes":["300x250"],"smaller_sizes_allowed":false,"position":"unknown","tag_format":"iframe","supply_type":"mobile_app","site_id":886154,"ad_profile_id":251049,"visibility_profile_id":990,"venue_id":744119,"inventory_source_id":1719,"allowed_media_types":[1],"media_subtypes":["banner"],"estimated_clear_price":0.248,"estimated_average_price":0.081,"id":3620009,"inventory_audits":[{"auditor_member_id":2066,"content_categories":[10,13]}]}],"bid_info":{"user_id_64":6254650908374539000,"no_cookies":false,"payment_rule_id":507442,"no_flash":false,"certified_supply":true,"user_agent":"Mozilla/5.0(iPad;CPUOS8_1_1likeMacOSX)AppleWebKit/600.1.4(KHTML,likeGecko)Mobile/12B435","browser":0,"operating_system":10,"operating_system_extended":129,"operating_system_family":3,"carrier":1,"device_make":26,"device_model":300,"device_type":3,"session_freq":1,"pub_session_freq":1,"ip_address":"76.30.108.22","country":"US","region":"TX","city":"SugarLand","postal_code":"77479","dma":618,"time_zone":"America/Chicago","inventory_class":"class_3","within_iframe":false,"device_ids":{"idfa":"${device_id}","sha1udid":"a9dea295df1cdb430706204134814a4c16bd9d99","md5udid":"52a2ffd2f1210a377d4365bbb816f386"},"selling_member_id":2066,"app_id":"123456","app_name":"AppName","mobile_app_instance_id":685,"inventory_audits":[{"auditor_member_id":null,"inventory_attributes":[]}],"userdata_json":"{}","segments":[{"id":1,"member_id":0,"code":"cookie_birthday","provider":"Appnexus","last_seen_min":23118867}]}}}	   
	   Set Test Variable    ${data}   		  {"id": "8765482113786061111","imp": [{"id": "449387476987463500","banner": {"w": 320,"h": 50,"id": "1","battr": [1, 2, 15],"pos": 0,"format": [{"w": 320,"h": 50}]},"instl": 0,"tagid": "12347654","secure": 1,"ext": {"appnexus": {"estimated_clear_price": 0.57,"predicted_view_rate": 0.073255,"member_ad_profile_id": 1111055,"predicted_video_completion_rate": 0.592172,"predicted_view_rate_over_total": 0.067229,"allowed_payment_types": [{"payment_type": 1,"imp_count_method": 2}]}}}],"app": {"id": "${app_id}","domain": "example.com","cat": ["IAB12-2", "IAB12", "IAB11-5"],"page": "https://example.com/somepage.html"},"device": {"ua": "Mozilla/5.0 (Linux; Android 6.0.1; HUAWEI Build/MMB28B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.137 Mobile Safari/537.36","geo": {"lat": 36.6203,"lon": -4.4998,"country": "US","region": "MA","metro": "1","city": "UnaCuidad","zip": "94110","utcoffset": 60,"ext": {"appnexus": {"timezone": "Africa/Ceuta"}}},"dnt": 0,"ip": "11.222.111.0","devicetype": 3,"ifa": "${device_id}","make": "Unknown","model": "Generic Android Mobile","os": "Android","language": "es","connectiontype": 0},"user": {"id": "7939999668795769876","buyeruid": "CABBBBrbuQ9AA5DMJJJJlOL9ZOo","gender": "O","data": [{"id": "0","segment": [{"id": "1","value": "0"}]}, {"id": "1234","segment": [{"id": "4444555","value": "0"}]}]},"test": 0,"at": 1,"tmax": 150,"wseat": ["1234"],"cur": ["USD"],"bcat": ["IAB23-7", "IAB23-5", "IAB23-10", "IAB23-9", "IAB23-1", "IAB7-44", "IAB9-9", "IAB8-18", "IAB8-5"],"badv": ["url1.com", "url2.com"],"ext": {"appnexus": {"seller_member_id": 123,"spend_protection": true,"publisher_integration": {"is_header": 0,"bid_shading_high": 1,"bid_shading_medium": 0.35,"bid_shading_low": 0.95}}},"source": {"fd": 1,"tid": "2dd111ff-7777-4abc-8558-86a123ab46d6"}}	
     
	   RTB Appnexus Request             ${RTB_APPNEXUS_API}        ${data} 
	   Start Read Requests Logs For Consumer Id			consumer_id=${device_id}	
	   #field 73 - pub id, field 74 - pub name
	   Should Match Regexp 			${output}  				73=f4d4108bc0a6ff8633fe88f671136eb8
	   Should Match Regexp 			${output}  				74=AppNexus: not available
	
